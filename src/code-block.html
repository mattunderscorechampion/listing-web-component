<script src="//cdn.jsdelivr.net/highlight.js/9.4.0/highlight.min.js"></script>
<template id="x-code-block-template">
    <style>
        @import "//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/tomorrow.min.css"
    </style>
    <pre style="text-align: left; font-size: 10pt; border: 1px solid grey;"><code>Loading</code><div name="caption" style="display: none; border-top: 1px solid grey; text-align: center;" /></pre>
</template>
<script>
(function() {
    var importDoc;
    if (document._currentScript) {
        importDoc = document._currentScript.ownerDocument;
    } else {
        importDoc = document.currentScript.ownerDocument;
    }
    var template = importDoc.querySelector('#x-code-block-template');

    var CodeBlockProto = Object.create(HTMLElement.prototype);
    CodeBlockProto.createdCallback = function() {
        var dataSrc = this.getAttribute('data-src');
        var dataCaption = this.getAttribute('data-caption');
        var gistElement = this;

        var shadow = gistElement.createShadowRoot();
        var clone = template.content.cloneNode(true);
        shadow.appendChild(document.importNode(clone, true));
        if (dataCaption) {
            var caption = shadow.querySelector('[name=caption]');
            caption.textContent = dataCaption;
            caption.style.display = 'block';
        }

        var request = new XMLHttpRequest();
        request.onreadystatechange = function () {
            var httpResponse = this;
            var DONE = httpResponse.DONE || 4;
            if (httpResponse.readyState === DONE) {
                var loadedClone = template.content.cloneNode(true);

                var code = loadedClone.childNodes[3].childNodes[0];
                code.textContent = httpResponse.responseText;
                hljs.highlightBlock(code);

                while (shadow.firstChild) {
                    shadow.removeChild(shadow.firstChild);
                }
                shadow.appendChild(document.importNode(loadedClone, true));
                if (dataCaption) {
                    var caption = shadow.querySelector('[name=caption]');
                    caption.textContent = dataCaption;
                    caption.style.display = 'block';
                }
            }
        };

        request.open('GET', dataSrc, true);
        request.send(null);
    };

    document.registerElement('x-code-block', {
        prototype: CodeBlockProto
    });
})();
</script>
